<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>WoD</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js'></script>
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" type="text/css"/>
<link rel='stylesheet' href='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.css' />
<style>
  html, body { margin:0; padding:0; height: 100%; }
  #map { width:100%; height: 100%; }
  #noneknown {
    z-index:2;
    position:absolute;
    bottom:0px;
    left:px;
    border-radius: 0px 5px 0px 0px;
    padding: 0px 4px 0px 10px;
    background: rgba(255,255,255,.75);
  }
  #popup {
    z-index:2;
    position:absolute;
    right:0px;
    top:0px;
    font-size: 12px;
    padding: 6px 8px;
    background: white;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    border-radius: 0px 0px 0px 5px;
    width: 300px;
  }
</style>
</head>
<body>
<div id="popup">
  <h5 id="prompt" class="text-center">Click on a country to learn about their drone regulations.</h5>
  <div id="detail"></div>
</div>
<div id="noneknown">
  <h5 class="text-center">Countries for which we have been unable to find explicit drone regulations are displayed in grey.</h5>
</div>
<div id='map'></div>
<script>
var CKAN_SEARCH = "https://data.opentechinstitute.org/api/3/action/datastore_search";
var CKAN_RESOURCE_REGULATIONS = "64ea51b2-96d4-4cb6-8684-f855b512588b";
   
// fetch the data
$.ajax({
  dataType: "json",
  url: CKAN_SEARCH,
  method: "POST",
  data: JSON.stringify({ "resource_id": CKAN_RESOURCE_REGULATIONS, "limit": 300 }),
  success: initMap
});

// reformat the CKAN record into GeoJSON
function toGeoJSONFeature(d) {
  return {
    "type": "Feature",
    "geometry": d.geometry,
    "properties": Object.keys(d)
      .filter(function(k) { return k != "geometry"; })
      .reduce(function(p,k) { p[k] = d[k]; return p; }, {})
  };
}

// wrap all the map logic in a function
function initMap(data) {
  var geojson = { "type": "FeatureCollection", "features": data.result.records.map(toGeoJSONFeature) };

  L.mapbox.accessToken = 'pk.eyJ1IjoibmV3YW1lcmljYSIsImEiOiIyM3ZnYUtrIn0.57fFgg_iM7S1wLH2GQC71g';
  var map = L.mapbox.map('map', 'newamerica.l89jcfpc',{
    maxZoom: 13,
    minZoom: 2,
    tileLayer: {
      continuousWorld: false,
      noWrap: true
    }
  });

  map.scrollWheelZoom.disable();

  var lastClickedLayer;

  function highlightFeature(e) {
    resetHighlight();
    var layer = e.target;
    $("#prompt").hide();
    $("#detail").show().html(layer.feature.properties.popupContent);
    layer.setStyle({
        weight: 5,
        fillOpacity: 0.5,
        fillColor: layer.feature.properties.reg_status_flag == "NONE KNOWN" ? "#999" : "#2dbbb3"
    });

    if (!L.Browser.ie && !L.Browser.opera) {
      layer.bringToFront();
    }
    lastClickedLayer = layer;
  }

  function resetHighlight(e) {
    if(myLayer && lastClickedLayer) {
      myLayer.resetStyle(lastClickedLayer);
    }
    $("#prompt").show();
    $("#detail").hide();
  }

  $(document).ready(function() {
    $("#map").click(resetHighlight);
  });
  
  function onEachFeature(feature, layer) {
      layer.on({
              click: highlightFeature
          });

      var props = feature.properties;
      if(props){
          var reg_sources = [];
          if(props.reg_official_source){
              var reg_source = props.reg_official_source;
              var reg_source_arr = reg_source.split("; ");

              for(i=0;i< reg_source_arr.length; i++){
                    var t = reg_source_arr[i].split(": ");
                    var p = '<a href="' + encodeURI(t[1]) + '" target="_blank" >' + t[0] + '</a>';
                    reg_sources.push(p);
              }
          }

          var reg_sec_sources = [];
          if(props.reg_secondary_source){
              var reg_sec_source = props.reg_secondary_source;
              var reg_sec_source_arr = reg_sec_source.split("; ");

              for(i=0;i< reg_sec_source_arr.length; i++){
                    var t = reg_sec_source_arr[i].split(": ");
                    var p = '<a href="' + encodeURI(t[1]) + '" target="_blank" >' + t[0] + '</a>';
                    reg_sec_sources.push(p);
              }
          }

          var preg_sources = [];
          if(props.pendingreg_official_source){
              var preg_source = props.pendingreg_official_source;
              var preg_source_arr = preg_source.split("; ");

              for(i=0;i< preg_source_arr.length; i++){
                    var t = preg_source_arr[i].split(": ");
                    var p = '<a href="' + encodeURI(t[1]) + '" target="_blank" >' + t[0] + '</a>';
                    preg_sources.push(p);
              }
          }

          var preg_sec_sources = [];
          if(props.pendingreg_secondary_source){
              var preg_sec_source = props.pendingreg_secondary_source;
              var preg_sec_source_arr = preg_sec_source.split("; ");

              for(i=0;i< preg_sec_source_arr.length; i++){
                    var t = preg_sec_source_arr[i].split(": ");
                    var p = '<a href="' + encodeURI(t[1]) + '" target="_blank" >' + t[0] + '</a>';
                    preg_sec_sources.push(p);
              }
          }

          var emFlight_sources = [];
          if(props.exampleflight_refurl){
              var emFlight_source = props.exampleflight_refurl;
              var emFlight_source_arr = emFlight_source.split("; ");

              for(i=0;i< emFlight_source_arr.length; i++){
                    var t = emFlight_source_arr[i].split(": ");
                    var p = '<a href="' + encodeURI(t[1]) + '" target="_blank" >' + t[0] + '</a>';
                    emFlight_sources.push(p);
              }
          }

          var enforcement_links = [];
          if(props.enforcement_action){
              var enforcement_link = props.enforcement_action;
              var enforcement_link_arr = enforcement_link.split("; ");

              for(i=0;i< enforcement_link_arr.length; i++){
                    var t = enforcement_link_arr[i].split(": ");
                    var p = '<a href="' + encodeURI(t[1]) + '" target="_blank" >' + t[0] + '</a>';
                    enforcement_links.push(p);
              }
          }

          var popupContent = '';
          popupContent += "<h4>" + props.country
              + "</h4><strong>Regulations: </strong>" + props.reg_explainer
              //+ "<br/><strong>Status: </strong>" + props.reg_status_flag
              + "<br/><strong>Source(s):</strong> ";
              for(i=0; i<reg_sources.length;i++){
                  if(i != reg_sources.length-1){ popupContent += reg_sources[i] + ", ";}
                  else { popupContent += reg_sources[i];}
                }

              if(props.reg_secondary_source){
                  popupContent += "<br /><strong>Secondary Source(s): </strong>";
                  for(i=0; i<reg_sec_sources.length;i++){
                      if(i != reg_sec_sources.length-1){ popupContent += reg_sec_sources[i] + ", ";}
                      else { popupContent += reg_sec_sources[i];}
                    }
              }

              if(props.pendingreg_explainer){
                  popupContent += "<br /><br /><strong>Pending Regulations: </strong>" + props.pendingreg_explainer
                  + "<br /><strong>Source(s): </strong>";
                  for(i=0; i<preg_sources.length;i++){
                      if(i != preg_sources.length-1){ popupContent += preg_sources[i] + ", ";}
                      else { popupContent += preg_sources[i];}
                  }

                  if(props.pendingreg_secondary_source){
                      popupContent += "<br /><strong>Secondary Source(s): </strong>";
                      for(i=0; i<preg_sec_sources.length;i++){
                          if(i != preg_sec_sources.length-1){ popupContent += preg_sec_sources[i] + ", ";}
                          else { popupContent += preg_sec_sources[i];}
                      }
                  }
              //+ "<br /><strong>Pending Regulations Status: </strong>" + props.pendingreg_status_flag;
              }

              if(props.exampleflight_description){
                  popupContent += "<br /><br /><strong>Example Flight(s): </strong>" + props.exampleflight_description
                  + "<br /><strong>Source(s): </strong>";
                  for(i=0; i<emFlight_sources.length;i++){
                          if(i != emFlight_sources.length-1){ popupContent += emFlight_sources[i] + ", ";}
                          else { popupContent += emFlight_sources[i];}
                      }
              }

              if(props.enforcement_action){
                  popupContent += "<br /><br /><strong>Enforcement Action: </strong>";
                  for(i=0; i<enforcement_links.length;i++){
                          if(i != enforcement_links.length-1){ popupContent += enforcement_links[i] + ", ";}
                          else { popupContent += enforcement_links[i];}
                      }
              }
          feature.properties.popupContent = popupContent;
      }
  }

  var myLayer = L.geoJson(geojson, {
    style: function(feature) {
      var unknown = feature.properties.reg_status_flag == "NONE KNOWN";
      return {
        color: unknown ? "#999" : "#2dbbb3",
        weight: 3,
        fillOpacity: unknown ? 0.2 : 0,
        fillColor: "#999"
      };
    },
    onEachFeature: onEachFeature
  }).addTo(map);
}
</script>



</body>
</html>
